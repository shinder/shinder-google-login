# 開發順序規劃：先前端還是先後端？

## 結論：建議先進行後端開發

## 為什麼先開發後端？

### 1. API 契約優先（API Contract First）

- 後端定義了 API 的介面規格（端點、請求/響應格式）
- 前端需要知道後端提供哪些 API 才能進行開發
- 確立 API 契約後，前後端可以並行開發（但初期仍建議先完成後端）

### 2. OAuth 驗證邏輯在後端

- Google ID Token 的驗證必須在後端進行（安全性考量）
- JWT 的生成和簽發也在後端
- 前端需要後端提供的 API 才能完成登入流程

### 3. 可以先用工具測試後端 API

- 使用 `curl`、Postman 或 Thunder Client 測試後端 API
- 確保後端邏輯正確無誤後再整合前端
- 減少前後端整合時的問題排查難度

### 4. 降低開發風險

- 後端是整個認證系統的核心
- 先確保核心邏輯正確，再開發 UI
- 避免前端開發到一半才發現後端 API 設計有問題

### 5. 便於調試

- 後端可以用簡單的 HTTP 請求測試
- 前端涉及 React 組件、狀態管理等，調試較複雜
- 分離關注點，先確保後端穩定

## 建議的開發順序

### 階段 1：後端核心功能（優先）

```
express_back/
├── 1. 安裝後端套件
│   └── pnpm add googleapis jsonwebtoken cors express-validator
├── 2. 設置 GCP OAuth 憑證
│   └── 在 Google Cloud Console 建立 OAuth 2.0 憑證
├── 3. 配置環境變數
│   └── 更新 .env 文件（GOOGLE_CLIENT_ID, JWT_SECRET 等）
├── 4. 實作 Google Token 驗證服務
│   └── services/googleAuth.js
├── 5. 實作 JWT 生成與驗證服務
│   └── services/tokenService.js
├── 6. 建立路由和控制器
│   ├── controllers/authController.js
│   └── routes/auth.js
├── 7. 添加 JWT 驗證中間件
│   ├── middleware/auth.js
│   └── middleware/errorHandler.js
└── 8. 測試 API 端點
    └── 使用 curl 或 Postman 測試所有端點
```

### 階段 2：前端整合

```
react_front/
├── 1. 安裝前端套件
│   └── pnpm add @react-oauth/google
├── 2. 建立 Google 登入組件
│   └── src/components/GoogleLoginButton.jsx
├── 3. 實作登入邏輯
│   └── 呼叫後端 API 並處理響應
├── 4. 實作 JWT 存儲和管理
│   ├── 創建 AuthContext 或使用狀態管理
│   └── 實作 token 存儲（localStorage 或 memory）
├── 5. 實作受保護的頁面/組件
│   ├── 創建 ProtectedRoute 組件
│   └── 在 API 請求中附加 Authorization header
└── 6. 測試完整流程
    └── 端到端測試：登入 → API 請求 → 登出
```

### 階段 3：優化與完善

```
優化項目
├── 1. 添加錯誤處理
│   ├── 後端：統一錯誤響應格式
│   └── 前端：友好的錯誤提示
├── 2. 改善用戶體驗
│   ├── 載入狀態（loading spinner）
│   ├── 錯誤提示（toast/notification）
│   └── 登入狀態持久化
├── 3. 添加 Token 自動刷新機制
│   ├── 前端：監聽 token 過期，自動刷新
│   └── 後端：實作 refresh token 端點
└── 4. 整合資料庫（如需要）
    ├── 選擇資料庫（PostgreSQL/MongoDB/SQLite）
    ├── 建立 User model
    └── 儲存 refresh token 用於撤銷
```

## 詳細開發步驟

### 階段 1 詳細步驟

#### 步驟 1.1：安裝後端套件

```bash
cd express_back
pnpm add googleapis jsonwebtoken cors express-validator
```

#### 步驟 1.2：設置 GCP OAuth 憑證

1. 前往 [Google Cloud Console](https://console.cloud.google.com/)
2. 建立新專案或選擇現有專案
3. 啟用 "Google Identity Services" 或 "Google+ API"
4. 建立 OAuth 2.0 憑證（Web 應用程式）
5. 設置授權來源和重定向 URI
6. 複製 Client ID 和 Client Secret

#### 步驟 1.3：配置環境變數

更新 `express_back/.env`：

```env
WEB_PORT=3001

# Google OAuth
GOOGLE_CLIENT_ID=your_client_id_here
GOOGLE_CLIENT_SECRET=your_client_secret_here

# JWT
JWT_ACCESS_SECRET=your_access_secret_min_32_chars
JWT_REFRESH_SECRET=your_refresh_secret_min_32_chars
JWT_ACCESS_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d

# CORS
FRONTEND_URL=http://localhost:5173
```

#### 步驟 1.4-1.7：實作核心代碼

建立以下目錄結構和文件：

```
express_back/
├── services/
│   ├── googleAuth.js      # Google Token 驗證
│   └── tokenService.js    # JWT 生成與驗證
├── middleware/
│   ├── auth.js            # JWT 驗證中間件
│   └── errorHandler.js    # 錯誤處理中間件
├── controllers/
│   └── authController.js  # 認證邏輯控制器
└── routes/
    └── auth.js            # 認證路由
```

參考 `docs/010-plan.md` 中的完整代碼範例。

#### 步驟 1.8：測試後端 API

使用 curl 測試（需要先獲取真實的 Google ID Token）：

```bash
# 測試首頁
curl http://localhost:3001/

# 測試 Google 登入（需要真實 token）
curl -X POST http://localhost:3001/api/auth/google \
  -H "Content-Type: application/json" \
  -d '{"idToken": "YOUR_GOOGLE_ID_TOKEN"}'

# 測試獲取用戶資料（需要 access token）
curl -X GET http://localhost:3001/api/auth/me \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# 測試刷新 Token
curl -X POST http://localhost:3001/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refreshToken": "YOUR_REFRESH_TOKEN"}'
```

### 階段 2 詳細步驟

#### 步驟 2.1：安裝前端套件

```bash
cd react_front
pnpm add @react-oauth/google
```

#### 步驟 2.2：建立 Google 登入組件

創建 `src/components/GoogleLoginButton.jsx`：

```jsx
import { GoogleLogin } from '@react-oauth/google';

export function GoogleLoginButton({ onSuccess, onError }) {
  return (
    <GoogleLogin
      onSuccess={onSuccess}
      onError={onError}
      text="signin_with"
      shape="rectangular"
      size="large"
    />
  );
}
```

#### 步驟 2.3：更新 App.jsx

```jsx
import { GoogleOAuthProvider } from '@react-oauth/google';
import { GoogleLoginButton } from './components/GoogleLoginButton';

function App() {
  const handleLoginSuccess = async (credentialResponse) => {
    try {
      const response = await fetch('http://localhost:3001/api/auth/google', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          idToken: credentialResponse.credential,
        }),
      });

      const data = await response.json();

      if (data.success) {
        localStorage.setItem('accessToken', data.accessToken);
        localStorage.setItem('refreshToken', data.refreshToken);
        console.log('登入成功:', data.user);
      }
    } catch (error) {
      console.error('登入失敗:', error);
    }
  };

  return (
    <GoogleOAuthProvider clientId={import.meta.env.VITE_GOOGLE_CLIENT_ID}>
      <div className="App">
        <h1>Google 登入示範</h1>
        <GoogleLoginButton
          onSuccess={handleLoginSuccess}
          onError={() => console.log('Login Failed')}
        />
      </div>
    </GoogleOAuthProvider>
  );
}

export default App;
```

#### 步驟 2.4：配置前端環境變數

創建 `react_front/.env`：

```env
VITE_GOOGLE_CLIENT_ID=your_google_client_id
VITE_API_URL=http://localhost:3001
```

## 開發時程估算

### 後端開發（階段 1）
- **時間估算**：4-6 小時
- **關鍵里程碑**：
  - [ ] 安裝套件和設置環境（30 分鐘）
  - [ ] 實作核心服務（2 小時）
  - [ ] 實作控制器和路由（1.5 小時）
  - [ ] 測試和調試（1-2 小時）

### 前端開發（階段 2）
- **時間估算**：3-4 小時
- **關鍵里程碑**：
  - [ ] 安裝套件和設置（20 分鐘）
  - [ ] 實作登入組件（1 小時）
  - [ ] 實作狀態管理（1 小時）
  - [ ] 整合測試（1-2 小時）

### 優化完善（階段 3）
- **時間估算**：2-4 小時
- **依實際需求調整**

## 注意事項

### 開發環境準備

1. **確保已安裝**：
   - Node.js（建議 v18+）
   - pnpm
   - Git

2. **GCP 帳號**：
   - 需要有 Google Cloud Platform 帳號
   - 建立專案並啟用 OAuth API

3. **開發工具**：
   - VS Code 或其他編輯器
   - Postman 或 Thunder Client（測試 API）
   - Chrome DevTools（前端調試）

### 常見問題預防

1. **CORS 問題**：
   - 確保後端正確設置 CORS
   - 前端請求包含正確的 headers

2. **環境變數**：
   - 確保 `.env` 文件不被提交到 Git
   - 檢查所有環境變數都已正確設置

3. **Token 驗證**：
   - Google Client ID 必須與前端使用的一致
   - JWT Secret 要足夠長且隨機

4. **端口衝突**：
   - 確保 3001（後端）和 5173（前端）端口未被占用

## 總結

**先開發後端的優勢**：
- ✅ 建立穩固的 API 基礎
- ✅ 可獨立測試核心邏輯
- ✅ 降低前後端整合風險
- ✅ 便於調試和問題排查
- ✅ 前端開發時有明確的 API 契約

**下一步**：開始實作後端核心功能（參考 `docs/010-plan.md`）
